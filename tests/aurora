NEWFS=$SRCROOT/tools/newfs_sls/newfs_sls
SLSCTL=$SRCROOT/tools/slsctl/slsctl

# Load and unload kernel modules
loadsls()
{
    kldload ../kmod/sls.ko
}

loadslos()
{
    kldload ../slos/slos.ko
}

loadmod()
{
    loadslos
    loadsls
}

# Unload the SLS. Necessary for unmounting/unloading the SLOS
unloadsls()
{
    kldunload sls
}

unloadslos()
{
    kldunload slos
}

unloadmod()
{
    unloadsls
    unloadslos
}

# Create and destroy memory device
createmd()
{
    MDDISK=`mdconfig -a -t malloc -s 1g`
    echo $MDDISK | cut -b3-
}

destroymd()
{
    mdconfig -d -u $MDDISK
}

slsnewfs()
{
    $NEWFS /dev/md$MDDISK > $TESTLOG 2> $TESTLOG
}

slsmount()
{
    mount -t slsfs /dev/md$MDDISK /mnt
}

slsunmount()
{
    umount /mnt
}

aursetup()
{
    loadmod
    slsnewfs
    slsmount
}

aurteardown()
{
    unloadsls
    slsunmount
    unloadslos
}

slscheckpoint()
{
    $SLSCTL attach -p $1 -m
    $SLSCTL checkpoint -m
}

slsrestore()
{
    $SLSCTL restore -m &
}

slsosdcheckpoint()
{
    $SLSCTL attach -p $1
    $SLSCTL checkpoint
}

slslazycheckpoint()
{
    $SLSCTL partadd -o $2 -l
    $SLSCTL attach -p $1 -o $2
    $SLSCTL checkpoint -o $2
}

slsosdrestore()
{
    $SLSCTL restore &
}

slslazyrestore()
{
    $SLSCTL restore -o $1 &
}

killandwait()
{
    kill $1
    wait $1
}
