NEWFS=$SRCROOT/tools/newfs_sls/newfs_sls
SLSCTL=$SRCROOT/tools/slsctl/slsctl

# Load and unload kernel modules
loadsls()
{
    kldload ../kmod/sls.ko
}

loadslos()
{
    kldload ../slos/slos.ko
}

loadmod()
{
    loadslos
    loadsls
}

# Unload the SLS. Necessary for unmounting/unloading the SLOS
unloadsls()
{
    kldunload sls
}

unloadslos()
{
    kldunload slos
}

# Create and destroy memory device
createmd()
{
    MDDISK=`mdconfig -a -t malloc -s 1g`
    echo $MDDISK | cut -b3-
}

destroymd()
{
    mdconfig -d -u $MDDISK
}

slsnewfs()
{
    $NEWFS /dev/md$MDDISK
}

slsmount()
{
    mount -t slsfs /dev/md$MDDISK /mnt
}

slsunmount()
{
    umount /mnt
}

aursetup()
{
    loadmod
    slsnewfs > /dev/null
    slsmount
}

aurteardown()
{
    unloadsls
    slsunmount
    unloadslos
}

slscheckpoint()
{
    $SLSCTL attach -p $1 -m
    $SLSCTL checkpoint -m
}

slsrestore()
{
    $SLSCTL restore -m &
}

slsosdcheckpoint()
{
    $SLSCTL attach -p $1
    $SLSCTL checkpoint
}

slsosdrestore()
{
    $SLSCTL restore &
}

killandwait()
{
    kill $1
    wait $1
}

# Run a command and make sure it fails
checkfail()
{
    # Have to execute the command in the if statement because of the -e flag.
    if $1 = 0; then
	exit 1
    fi
    exit 0
}
