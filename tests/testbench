#!/bin/sh

export KTRLOG="ktrdump.log"
export TESTLOG="testbench.log"

TIMEOUT=30

export SRCROOT="$PWD/.."
. aurora

ESC=`printf "\033"`
CR=`printf "\015"`
CLEAR="$CR$ESC[K"
RED=$ESC"[0;31m"
GREEN=$ESC"[0;32m"
#YELLOW= $ESC"[0;33m"
NORMAL=$ESC"[0;39m"

FORMAT="%-40s [ %s%-7s"$NORMAL" ]"
TFORMAT="%-40s [ %s%-7s"$NORMAL" ] %6s"

print_fail()
{
    echo -n $CLEAR
    printf "$FORMAT\n" $1 $RED "fail"
}

print_success()
{
    echo -n $CLEAR
    printf "$TFORMAT\n" $1 $GREEN "success" $2
}

print_running()
{
    printf "$FORMAT" $1 "" "running"
}

cleanup_testbench()
{
	# For good measure, if something went really wrong.
	aurteardown
	destroymd $MDDISK
	exit 0
}

run_test()
{
    NAME=`basename $1`
    print_running $NAME
    tstart=`date +%s`
    $1 >> $TESTLOG
    RETVAL=$?
    tstop=`date +%s`
    if [ $RETVAL -eq 0 ]; then
	print_success $NAME `expr $tstop - $tstart`
    else
	print_fail $NAME
	ktrdump >> $KTRLOG
	exit 0
    fi
}

test_banner()
{
    echo Build: `uname -sri`
    echo Host: `hostname`
    echo Test started: `date`
    printf "%-40s   %-9s   %-10s\n" "Test" "Status" "Time"
    echo "-----------------------------------------------------------"
}

run_all_tests()
{
    rm -f $TESTLOG
    rm -f $KTRLOG
    touch $TESTLOG

    test_banner
    for t in `find $SRCROOT/tests -maxdepth 1 -name \*.sh | sort -n`; do
	run_test $t
    done
}

run_tests()
{
    if [ $# -eq 0 ]; then
	echo "No tests found"
	exit 0
    fi

    rm -f $TESTLOG
    rm -f $KTRLOG
    touch $TESTLOG

    test_banner
    for t in $1; do
	run_test "$SRCROOT/tests/$t"
    done
}

# Cleanup any leftover Aurora state.
aurteardown 1>/dev/null 2>/dev/null

createmd

export MDDISK
export DISK
export DISKPATH

# Create a directory tree for the root if needed
createroot

if [ $# -ge 1 ]; then
    INPUTS=""
    for i in $@; do
	INPUTS="$INPUTS $i"
    done
    run_tests "$INPUTS"
else
    run_all_tests
fi

cleanup_testbench > /dev/null 2> /dev/null
